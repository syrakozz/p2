FROM golang:1.21-alpine as builder

WORKDIR /go/delivery
COPY . .

RUN apk add gcc g++ opus-dev

RUN go install github.com/mgechev/revive@v1.3.4

RUN go build -ldflags "-s -w" disruptive/cmd/saged

RUN revive -set_exit_status cmd/common/...
RUN revive -set_exit_status cmd/saged/...
RUN revive -set_exit_status lib/deepgram/...
RUN revive -set_exit_status lib/elevenlabs/...
RUN revive -set_exit_status lib/firebase/...
RUN revive -set_exit_status lib/firestore/...
RUN revive -set_exit_status lib/gcp/...
RUN revive -set_exit_status lib/openai/...
RUN revive -set_exit_status lib/pinecone/...
RUN revive -set_exit_status lib/sage/...
RUN revive -set_exit_status lib/stabilityai/...
RUN revive -set_exit_status pkg/vox/...
RUN revive -set_exit_status rest/auth/...
RUN revive -set_exit_status rest/firebase/...
RUN revive -set_exit_status rest/lib/...
RUN revive -set_exit_status rest/openai/...
RUN revive -set_exit_status rest/sage/...
RUN revive -set_exit_status rest/vox/...

RUN go test ./lib/openai/...
RUN go test ./lib/sage/...
